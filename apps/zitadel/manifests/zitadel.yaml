---
# Source: zitadel/templates/service_zitadel.yaml
apiVersion: v1
kind: Service
metadata:
  name: zitadel
  annotations:
    traefik.ingress.kubernetes.io/service.serversscheme: h2c
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http2-server
      appProtocol: kubernetes.io/h2c
  selector:
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/component: start
---
# Source: zitadel/templates/deployment_zitadel.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zitadel
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: start
spec:
  revisionHistoryLimit: 10
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: zitadel
      app.kubernetes.io/instance: zitadel
      app.kubernetes.io/component: start
  template:
    metadata:
      annotations:
        checksum/configmap: eddd2ef6faff676dc16581a5883343f055c5a574cdad6abd99146be2a7c3aae8
        checksum/secret-db-ssl-ca-crt: 01ba4719c80b6fe911b091a7c05124b64eeece964e09c058ef8f9805daca546b
        checksum/secret-zitadel-secrets: 94e142266ef22c58e43d05f32122e87f4bfd453d175c92e28a562ac45d669d04
      labels:
        helm.sh/chart: zitadel-9.15.0
        app.kubernetes.io/name: zitadel
        app.kubernetes.io/instance: zitadel
        app.kubernetes.io/version: ""
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: start
    spec:
      serviceAccountName: zitadel
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      enableServiceLinks: false
      containers:
        - name: zitadel
          securityContext:
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
          image: "ghcr.io/zitadel/zitadel:v4.2.0"
          imagePullPolicy: IfNotPresent
          args:
            - start
            - --config
            - /config/zitadel-config-yaml
            - --config
            - /zitadel-secrets-yaml/zitadel-secrets-yaml
            - --masterkeyFromEnv
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: ZITADEL_MASTERKEY
              valueFrom:
                secretKeyRef:
                  name: zitadel-masterkey
                  key: masterkey
          ports:
          - containerPort: 8080
            name: http2-server
            protocol: TCP
          livenessProbe:
            httpGet:
              path: /debug/healthz
              port: http2-server
              httpHeaders:
                - name: Host
                  value: auth.abutt.dev
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /debug/ready
              port: http2-server
              httpHeaders:
                - name: Host
                  value: auth.abutt.dev
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 5
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /debug/ready
              port: http2-server
              httpHeaders:
                - name: Host
                  value: auth.abutt.dev
              scheme: HTTP
            periodSeconds: 1
            failureThreshold: 30
          volumeMounts:
          - name: zitadel-config-yaml
            mountPath: /config
            readOnly: true
          - name: zitadel-secrets-yaml
            mountPath: /zitadel-secrets-yaml
            readOnly: true
          resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
      initContainers:
      # The following initContainer is conditional. It is only added if the
      # PostgreSQL endpoint can be fully determined from the Helm values. This is
      # necessary to gracefully handle configurations where database credentials are
      # provided via external secrets (instead of the values file), which would
      # otherwise cause a template rendering error during `helm install`.
        # This initContainer acts as a dependency check before the main application
        # starts. It uses the `wait4x` tool to pause the pod's startup sequence
        # until the PostgreSQL database is accepting TCP connections. This prevents
        # the main ZITADEL container from starting and potentially crashing before its
        # database is available, thus improving deployment reliability.
        - name: wait-for-postgres
          image: wait4x/wait4x:3.6
          command:
            - wait4x
            - tcp
            - postgres.zitadel.svc.cluster.local:5432
            - --timeout
            - "5m"
            - --interval
            - "5s"
          securityContext:
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
      volumes:
      - name: zitadel-config-yaml
        configMap:
          name: zitadel-config-yaml
      - name: zitadel-secrets-yaml
        secret:
          secretName: zitadel-secrets-yaml
          defaultMode: 0440
---
# Source: zitadel/templates/hpa_login.yaml
#file: noinspection ExcessiveWhitespaceTrimInspection,KubernetesUnknownResourcesInspection
---
# Source: zitadel/templates/hpa_zitadel.yaml
#file: noinspection ExcessiveWhitespaceTrimInspection,KubernetesUnknownResourcesInspection
---
# Source: zitadel/templates/secret_self-signed.yaml
#file: noinspection HelmUnknownValues
---
# Source: zitadel/templates/servicemonitor.yaml
#file: noinspection KubernetesUnknownResourcesInspection
---
# Source: zitadel/templates/serviceaccount_zitadel.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: zitadel
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
---
# Source: zitadel/templates/secret_zitadel-masterkey.yaml
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: zitadel-masterkey
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
stringData:
  masterkey: CHANGE_ME_32_CHARACTER_MASTERKEY
---
# Source: zitadel/templates/secret_zitadel-secrets.yaml
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: zitadel-secrets-yaml
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
stringData:
  zitadel-secrets-yaml: |-
    
    Database:
      Postgres:
        Admin:
          Password: zitadel-db-password
        User:
          Password: zitadel-db-password
---
# Source: zitadel/templates/configmap_zitadel.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: zitadel-config-yaml
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
data:
  zitadel-config-yaml: |-
    Database:
      Postgres:
        Admin:
          SSL:
            Mode: disable
          Username: zitadel
        Database: zitadel
        Host: postgres.zitadel.svc.cluster.local
        Port: 5432
        User:
          SSL:
            Mode: disable
          Username: zitadel
    ExternalDomain: auth.abutt.dev
    ExternalPort: 443
    ExternalSecure: true
    FirstInstance:
      LoginClientPatPath: null
      MachineKeyPath: null
      Org:
        LoginClient:
          Machine:
            Name: Automatically Initialized IAM Login Client
            Username: login-client
          Pat:
            ExpirationDate: "2029-01-01T00:00:00Z"
        Machine:
          Machine:
            Name: Automatically Initialized IAM Admin
            Username: iam-admin
          MachineKey:
            ExpirationDate: "2029-01-01T00:00:00Z"
            Type: 1
          Pat:
            ExpirationDate: "2029-01-01T00:00:00Z"
        Skip: null
      PatPath: null
      Skip: false
    Machine:
      Identification:
        Hostname:
          Enabled: true
        Webhook:
          Enabled: false
    TLS:
      Enabled: false
---
# Source: zitadel/templates/rbac_zitadel.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: zitadel
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
rules:
  - apiGroups: [ "" ]
    resources: [ "secrets" ]
    verbs: [ "get", "create", "list", "delete" ]
  - apiGroups: [ "" ]
    resources: [ "pods" ]
    verbs: [ "get" ]
---
# Source: zitadel/templates/rbac_zitadel.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: zitadel
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
subjects:
  - kind: ServiceAccount
    name:  zitadel
roleRef:
  kind: Role
  name: zitadel
  apiGroup: rbac.authorization.k8s.io
---
# Source: zitadel/templates/job_cleanup.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "zitadel-cleanup"
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: cleanup
  annotations:
    helm.sh/hook: post-delete
    helm.sh/hook-delete-policy: hook-succeeded
    helm.sh/hook-weight: "-1"
spec:
  backoffLimit: 3
  activeDeadlineSeconds: 60
  template:
    metadata:
      labels:
        helm.sh/chart: zitadel-9.15.0
        app.kubernetes.io/name: zitadel
        app.kubernetes.io/instance: zitadel
        app.kubernetes.io/version: ""
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: cleanup
    spec:
      serviceAccountName: zitadel
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      enableServiceLinks: false
      restartPolicy: Never
      containers:
        - name: "zitadel-cleanup"
          securityContext:
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
          image: "alpine/k8s:1.34.0"
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              echo "Cleaning up secrets created by zitadel-setup..."
              kubectl --namespace=zitadel delete secret \
                --selector='app.kubernetes.io/managed-by=Zitadel,app.kubernetes.io/instance=zitadel' \
                --ignore-not-found=true
              echo "Cleanup completed"
          resources:
              {}
---
# Source: zitadel/templates/job_init.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "zitadel-init"
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: init
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "1"
spec:
  backoffLimit: 5
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        helm.sh/chart: zitadel-9.15.0
        app.kubernetes.io/name: zitadel
        app.kubernetes.io/instance: zitadel
        app.kubernetes.io/version: ""
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: init
    spec:
      serviceAccountName: zitadel
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      enableServiceLinks: false
      restartPolicy: Never
      containers:
        - name: "zitadel-init"
          securityContext:
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
          image: "ghcr.io/zitadel/zitadel:v4.2.0"
          imagePullPolicy: IfNotPresent
          args:
            - init
            - --config
            - /config/zitadel-config-yaml
            - --config
            - /zitadel-secrets-yaml/zitadel-secrets-yaml
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
          volumeMounts:
          - name: zitadel-config-yaml
            mountPath: /config
            readOnly: true
          - name: zitadel-secrets-yaml
            mountPath: /zitadel-secrets-yaml
            readOnly: true
          resources:
              {}
      volumes:
      - name: zitadel-config-yaml
        configMap:
          name: zitadel-config-yaml
          defaultMode: 0440
      - name: zitadel-secrets-yaml
        secret:
          secretName: zitadel-secrets-yaml
          defaultMode: 0440
---
# Source: zitadel/templates/job_setup.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "zitadel-setup"
  labels:
    helm.sh/chart: zitadel-9.15.0
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/instance: zitadel
    app.kubernetes.io/version: ""
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: setup
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "2"
spec:
  backoffLimit: 5
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        helm.sh/chart: zitadel-9.15.0
        app.kubernetes.io/name: zitadel
        app.kubernetes.io/instance: zitadel
        app.kubernetes.io/version: ""
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: setup
    spec:
      serviceAccountName: zitadel
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      enableServiceLinks: false
      restartPolicy: Never
      containers:
        - name: "zitadel-setup"
          securityContext:
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
          image: "ghcr.io/zitadel/zitadel:v4.2.0"
          imagePullPolicy: IfNotPresent
          args:
            - setup
            - --masterkeyFromEnv
            - --config
            - /config/zitadel-config-yaml
            - --steps
            - /config/zitadel-config-yaml
            - --config
            - /zitadel-secrets-yaml/zitadel-secrets-yaml
            - --steps
            - /zitadel-secrets-yaml/zitadel-secrets-yaml
            - --init-projections=true
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: ZITADEL_MASTERKEY
              valueFrom:
                secretKeyRef:
                  name: zitadel-masterkey
                  key: masterkey
            - name: ZITADEL_FIRSTINSTANCE_MACHINEKEYPATH
              value: "/machinekey/sa.json"
            - name: ZITADEL_FIRSTINSTANCE_PATPATH
              value: "/machinekey/pat"
            - name: ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH
              value: "/login-client/pat"
          volumeMounts:
          - name: zitadel-config-yaml
            mountPath: /config
            readOnly: true
          - name: zitadel-secrets-yaml
            mountPath: /zitadel-secrets-yaml
            readOnly: true
          - name: machinekey
            mountPath: "/machinekey"
          - name: login-client
            mountPath: "/login-client"
          resources:
            {}
        - name: "zitadel-machinekey"
          securityContext:
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
          image: "alpine/k8s:1.32.0"
          command:
            - sh
            - -c
            - |
              until [ ! -z $(kubectl --namespace=zitadel get pod ${POD_NAME} --output=jsonpath="{.status.containerStatuses[?(@.name=='zitadel-setup')].state.terminated}") ]; do
                echo 'waiting for zitadel-setup container to terminate';
                sleep 5;
              done &&
              echo 'zitadel-setup container terminated' &&
              if [ -f /machinekey/sa.json ]; then
                kubectl --namespace=zitadel create secret generic iam-admin \
                  --from-file=iam-admin.json=/machinekey/sa.json \
                  --dry-run=client --output=yaml | \
                kubectl label --local --filename=- \
                  app.kubernetes.io/managed-by=Zitadel \
                  app.kubernetes.io/name=zitadel \
                  app.kubernetes.io/instance=zitadel \
                  --output=yaml | \
                kubectl apply --filename=-;
              fi;
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: machinekey
              mountPath: "/machinekey"
              readOnly: true
          resources:
            {}
        - name: "zitadel-machine-pat"
          securityContext:
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
          image: "alpine/k8s:1.32.0"
          command:
            - sh
            - -c
            - |
              until [ ! -z $(kubectl --namespace=zitadel get pod ${POD_NAME} --output=jsonpath="{.status.containerStatuses[?(@.name=='zitadel-setup')].state.terminated}") ]; do
                echo 'waiting for zitadel-setup container to terminate';
                sleep 5;
              done &&
              echo 'zitadel-setup container terminated' &&
              if [ -f /machinekey/pat ]; then
                kubectl --namespace=zitadel create secret generic iam-admin-pat \
                  --from-file=pat=/machinekey/pat \
                  --dry-run=client --output=yaml | \
                kubectl label --local --filename=- \
                  app.kubernetes.io/managed-by=Zitadel \
                  app.kubernetes.io/name=zitadel \
                  app.kubernetes.io/instance=zitadel \
                  --output=yaml | \
                kubectl apply --filename=-;
              fi;
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: machinekey
              mountPath: "/machinekey"
              readOnly: true
          resources:
            {}
        - name: "zitadel-login-client-pat"
          securityContext:
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
          image: "alpine/k8s:1.32.0"
          command:
            - sh
            - -c
            - |
              until [ ! -z $(kubectl --namespace=zitadel get pod ${POD_NAME} --output=jsonpath="{.status.containerStatuses[?(@.name=='zitadel-setup')].state.terminated}") ]; do
                echo 'waiting for zitadel-setup container to terminate';
                sleep 5;
              done &&
              echo 'zitadel-setup container terminated' &&
              if [ -f /login-client/pat ]; then
                kubectl --namespace=zitadel create secret generic login-client \
                  --from-file=pat=/login-client/pat \
                  --dry-run=client --output=yaml | \
                kubectl label --local --filename=- \
                  app.kubernetes.io/managed-by=Zitadel \
                  app.kubernetes.io/name=zitadel \
                  app.kubernetes.io/instance=zitadel \
                  --output=yaml | \
                kubectl apply --filename=-;
              fi;
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: login-client
              mountPath: "/login-client"
              readOnly: true
          resources:
            {}
      volumes:
      - name: zitadel-config-yaml
        configMap:
          name: zitadel-config-yaml
          defaultMode: 0440
      - name: zitadel-secrets-yaml
        secret:
          secretName: zitadel-secrets-yaml
          defaultMode: 0440
      - name: machinekey
        emptyDir: { }
      - name: login-client
        emptyDir: { }
